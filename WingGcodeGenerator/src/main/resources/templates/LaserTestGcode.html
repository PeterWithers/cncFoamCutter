<!DOCTYPE html>
<!--
Copyright (C) 2017 Peter Withers
-->

<!--
 * @since Dec 20, 2017 19:45 PM (creation date)
 * @author <peter-gthb@bambooradical.com>
-->
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:th="http://www.thymeleaf.org">
    <head>
        <title>Laser Test GCODE</title>
        <meta charset="UTF-8"/>
        <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
        <style th:include="WingDesignView :: stylesection"></style>        
    </head> 
    <body>
        <br/>
        <br/>
        <div th:fragment="propEditor">
            <div id="editorForm">
                <form method="get" action="#" th:action="@{/LaserTestGcode}" th:object="${laserTestGcodeData}">
                    Aerofoil&nbsp;
                    <select id="rootAerofoilId" name="aerofoilData">
                        <option value="-1">test pattern</option>
                        <option th:each="aerofoil : ${aerofoilList}" 
                                th:value="${aerofoil.getId()}" 
                                th:text="${aerofoil.getName()}"
                                th:selected="${laserTestGcodeData.aerofoilData != null and aerofoil.getId() == laserTestGcodeData.aerofoilData.getId()}"></option>
                    </select>&nbsp;Chord&nbsp;mm&nbsp;<input type="number" th:field="*{chordLength}" />&nbsp;todo: add kerf parameter<br/><br/>
                    Grid&nbsp;Size&nbsp;<input type="number" th:field="*{gridSize}" />
                    Line&nbsp;Spacing&nbsp;<input type="number" th:field="*{lineSpacing}" />
                    Line&nbsp;Steps&nbsp;<input type="number" step="any" th:field="*{lineSteps}" /><br/><br/>
                    Line&nbsp;Zigzag&nbsp;<input type="number" step="any" th:field="*{lineZigzag}" /><br/><br/>
                    Fly&nbsp;Speed&nbsp;<input type="number" th:field="*{flySpeed}" /><br/><br/>
                    Minimum&nbsp;Power&nbsp;<input type="number" th:field="*{minPower}" />
                    Maximum&nbsp;Power&nbsp;<input type="number" th:field="*{maxPower}" /><br/><br/>
                    Minimum&nbsp;Speed&nbsp;<input type="number" th:field="*{minSpeed}" />
                    Maximum&nbsp;Speed&nbsp;<input type="number" th:field="*{maxSpeed}" /><br/><br/>
                    <button type="submit" id="saveButton" >Update</button>
                </form>
            </div>            
            <svg id="editSvgPanel" th:attr="viewBox=${'-5 -55 '+(laserTestGcodeData.gridSize+laserTestGcodeData.chordLength+30)+' '+(laserTestGcodeData.gridSize+laserTestGcodeData.chordLength+30)}">
                <g id="grid">
                    <line th:each="yRow : ${#numbers.sequence( -50, (laserTestGcodeData.gridSize+laserTestGcodeData.chordLength-30))}" x1="0" th:attr="y1=${yRow}, y2=${yRow}, x2=${laserTestGcodeData.gridSize+laserTestGcodeData.chordLength+20}" style="stroke:rgba(50,50,50, 150);stroke-width:0.1" />
                    <line th:each="yRow : ${#numbers.sequence( -5, (laserTestGcodeData.gridSize+laserTestGcodeData.chordLength)/10-3)}" x1="-5" th:attr="y1=${yRow*10}, y2=${yRow*10}, x2=${laserTestGcodeData.gridSize+laserTestGcodeData.chordLength+25}" style="stroke:rgba(100,100,100, 150);stroke-width:0.1" />
                    <line th:each="xRow : ${#numbers.sequence( 0, (laserTestGcodeData.gridSize+laserTestGcodeData.chordLength)+20)}" y1="-50" th:attr="x1=${xRow}, x2=${xRow}, y2=${laserTestGcodeData.gridSize+laserTestGcodeData.chordLength-30}" style="stroke:rgba(50,50,50, 150);stroke-width:0.1" />
                    <line th:each="xRow : ${#numbers.sequence( 0, (laserTestGcodeData.gridSize+laserTestGcodeData.chordLength)/10+2)}" y1="-55" th:attr="x1=${xRow*10}, x2=${xRow*10}, y2=${(laserTestGcodeData.gridSize+laserTestGcodeData.chordLength-25)}" style="stroke:rgba(100,100,100, 150);stroke-width:0.1" />
                </g>
                <!--<path class="aerofoilEditLines" id="extrusionPath" th:attr="d=${laserTestGcodeData.getSvgPoints()}"/>-->
                <g transform="translate(20, -30)">
                    <path th:each="pathString, iterator : ${laserTestGcodeData.getSvgPoints()}" th:class="${laserTestGcodeData.getSvgPointsClass(iterator.index, iterator.size)}" th:attr="d=${pathString}">
                        <animate th:if="${iterator.index} eq 0" attributeName="stroke-dashoffset" from="1000" to="0" begin="1s" dur="2s" repeatCount="indefinite" />
                    </path>
                    <text y="-5" x="0"  fill="grey" th:text="${'S'+laserTestGcodeData.minPower}" style="font-size : 10px;">minPower</text>
                    <text y="-5" th:attr="x=${laserTestGcodeData.gridSize-10}" fill="grey" th:text="${'S'+laserTestGcodeData.maxPower}" style="font-size : 10px;">maxPower</text>
                    <text x="-10" y="0" fill="grey" th:text="${'F'+laserTestGcodeData.minSpeed}" transform="rotate(-90 0,5)" style="font-size:10px;text-anchor:'end'">minSpeed</text>
                    <text x="10" th:attr="y=${laserTestGcodeData.gridSize+10},transform=${'rotate(-90 -0,'+(laserTestGcodeData.gridSize+15)+')'}" fill="grey" th:text="${'F'+laserTestGcodeData.maxSpeed}" style="font-size:10px;text-anchor:'end'">maxSpeed</text>
                    <line id="laserY" x1="-20" y1="-30" y2="-30" th:attr="x2=${laserTestGcodeData.gridSize+laserTestGcodeData.chordLength}" style="stroke:red;stroke-width:1" />
                    <line id="laserX" y1="-20" x1="-30" x2="-30" th:attr="y2=${laserTestGcodeData.gridSize+laserTestGcodeData.chordLength}" style="stroke:red;stroke-width:1" />
                </g>
            </svg>   
            <br/>
            <pre id="gcode" th:text="${laserTestGcodeData.getGcode()}"></pre>
        </div>
        <script th:inline="javascript">
            /*<![CDATA[*/
            var gcodeString = /*[[${laserTestGcodeData.getGcode()}]]*/ '#no data';
            parent.postMessage(gcodeString, "*");
            window.addEventListener("message", function (event) {
                event.data.split(" ").forEach(function (codePart) {
                    if (codePart.startsWith("Y")) {
                        var yPos = codePart.substring(1);
                        var laserY = document.getElementById("laserY");
                        laserY.setAttribute("y1", yPos);
                        laserY.setAttribute("y2", yPos);
                    }
                    if (codePart.startsWith("X")) {
                        var xPos = codePart.substring(1);
                        var laserX = document.getElementById("laserX");
                        laserX.setAttribute("x1", xPos);
                        laserX.setAttribute("x2", xPos);
                    }
                });
                document.getElementById("gcode").innerHTML = event.data;
            }, false);
            /*]]>*/
        </script>
        <div id="menu" style="position: fixed; top: 5px;">
            <a href='#editSvgPanel'>Preview</a>
            <a href='#gcode'>View GCODE</a>
            <a th:href="${'laserGcode?' + #httpServletRequest.queryString}">Download GCODE</a>
            <a href="WingDesignView">WingDesignView</a>
            <a href="AerofoilListing">AerofoilListing</a>
        </div>
    </body>
</html>
